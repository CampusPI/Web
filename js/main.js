"use strict";angular.module("tvApp",["ngResource","btford.modal","ngRoute","googleOauth","td.easySocialShare"]).config(function($routeProvider){$routeProvider.when("/",{templateUrl:"templates/home.html"}).when("/list/favoritos",{templateUrl:"templates/list.html",controller:"favsCtrl"}).when("/content/:type",{templateUrl:"templates/content.html",controller:"typeContentCtrl"}).when("/view/:id",{templateUrl:"templates/view.html",controller:"contentCtrl"}).when("/upload",{templateUrl:"templates/upload.html",controller:"uploadCtrl"})}).config(function(TokenProvider){TokenProvider.extendConfig({clientId:"859779641004-cvl4ppt05dj26eprlv0eer3hrbmkpudf.apps.googleusercontent.com",redirectUri:"http://campuspi.github.io/Web/oauth2callback.html",scopes:["https://www.googleapis.com/auth/userinfo.email"]})}),angular.module("tvApp").constant("endpoint","http://server.pi.campinhos.pt"),angular.module("tvApp").factory("ScheduleService",function($http,endpoint){return{get:function(){return $http({method:"GET",url:endpoint+"/api/tv/lastContent"}).then(function(response){var a=response.data.reverse().slice(1);return a})},getId:function(id){return $http({method:"GET",url:endpoint+"/api/tv/schedule"}).then(function(response){return response.data.filter(function(element){return element._id===id})})},getc:function(id){return $http({method:"GET",url:endpoint+"/api/web/content/"+id}).then(function(response){return response.data})}}}),angular.module("tvApp").factory("VideosService",function($http,endpoint){return{get:function(){return $http({method:"GET",url:endpoint+"/api/web/videos"}).then(function(response){var a=response.data.slice(1);return a})}}}),angular.module("tvApp").factory("NewsService",function($http,endpoint){return{get:function(){return $http({method:"GET",url:endpoint+"/api/web/news"}).then(function(response){var a=response.data.slice(1);return a})}}}),angular.module("tvApp").factory("EventsService",function($http,endpoint){return{get:function(){return $http({method:"GET",url:endpoint+"/api/web/biblio"}).then(function(response){var a=response.data.slice(1);return a})}}}),angular.module("tvApp").factory("UpdateService",function($http,endpoint){return{"new":function(){return $http({method:"GET",url:endpoint+"/api/tv/currentContent"}).then(function(response){return response.data})},isNew:function(){return!0}}}),angular.module("tvApp").factory("LoginService",function($http,endpoint,Token,$location){return{accessToken:null,user:null,verify:function(fn){var self=this;self.accessToken=Token.get(),self.accessToken?Token.verifyAsync(self.accessToken).then(function(){$http.get(endpoint+"/api/web/user",{headers:{Authorization:"Bearer "+self.accessToken}}).success(function(data){return self.user=data,fn(self.user)})},function(){console.log("Failed to verify token."),fn(null)}):fn(null)},login:function(){Token.extendConfig({state:$location.absUrl()}),Token.getTokenWithRedirect({})}}}),angular.module("tvApp").factory("UploadService",function($http,endpoint,Token){return{setVideo:function(videoId){return $http({method:"POST",url:endpoint+"/api/web/upload",headers:{Authorization:"Bearer "+Token.get()},data:{type:"video",videoId:videoId}}).then(function(response){console.log(response.data)})},setNew:function(titulo,conteudo,url,date){return $http({method:"POST",url:endpoint+"/api/web/upload",headers:{Authorization:"Bearer "+Token.get()},data:{type:"new",titulo:titulo,conteudo:conteudo,link:url,publicado:date}}).then(function(response){return response.data})}}}),angular.module("tvApp").factory("FavoritesService",function($http,endpoint,Token){return{getFavorites:function(){return $http({method:"GET",url:endpoint+"/api/web/favorites",headers:{Authorization:"Bearer "+Token.get()}}).then(function(response){return response.data})},addFavorite:function(videoid){return $http({method:"POST",url:endpoint+"/api/web/favorites",headers:{Authorization:"Bearer "+Token.get()},data:{id:videoid}}).then(function(response){return response.data})},removeFavorite:function(id){return $http({method:"DELETE",url:endpoint+"/api/web/favorites",headers:{Authorization:"Bearer "+Token.get()},data:{id:id}}).then(function(response){return response.data})},isFav:function(id){return $http({method:"GET",url:endpoint+"/api/web/favorites",headers:{Authorization:"Bearer "+Token.get()}}).then(function(response){return console.log(response.data),console.log(id),response.data.filter(function(element){return element._id===id})})}}}),angular.module("tvApp").controller("appCtrl",function($scope,ScheduleService,$location,UpdateService,$interval,LoginService){$scope.getClass=function(path){return $location.path().substr(0,path.length)===path?"selected":""};var l=function(){$scope.logged=!1,$scope.log=!1,LoginService.verify(function(user){user?(console.log(user),$scope.user=user,$scope.logged=!0,$scope.log=!1):($scope.log=!0,$scope.logged=!1)})};l(),$scope.login=function(){LoginService.login()},$scope.logout=function(){localStorage.removeItem("accessToken"),l()};var apdete=function(){UpdateService.new().then(function(data){JSON.stringify($scope.new)!==JSON.stringify(data[0])&&($scope.new=data[0])}),ScheduleService.get().then(function(data){$scope.coisas=data,$scope.imgDef="http://www.fct.unl.pt/sites/default/files/imagens/noticias/noticias.jpg"})};apdete(),$interval(apdete,1e4),$scope.go=function(path){$location.path(path)}}),angular.module("tvApp").controller("contentCtrl",function($scope,$routeParams,ScheduleService,FavoritesService){console.log($routeParams),$scope.isFav=null,$scope.id=$routeParams.id,ScheduleService.getc($routeParams.id).then(function(data){console.log(data),$scope.data=data});var isfav=function(){FavoritesService.isFav($scope.id).then(function(res){$scope.isFav=res.length>0?!0:!1,console.log($scope.isFav)})};isfav(),$scope.rem=function(id){FavoritesService.removeFavorite(id).then(function(){isfav()})},$scope.add=function(id){FavoritesService.addFavorite(id).then(function(){isfav()})}}),angular.module("tvApp").controller("typeContentCtrl",function($scope,$routeParams,VideosService,NewsService,EventsService){$scope.type=$routeParams.type,"videos"===$routeParams.type?VideosService.get().then(function(data){$scope.videos=data}):"noticias"===$routeParams.type?NewsService.get().then(function(data){$scope.news=data,$scope.imgDef="http://www.fct.unl.pt/sites/default/files/imagens/noticias/noticias.jpg"}):"eventos"===$routeParams.type&&EventsService.get().then(function(data){$scope.events=data})}),angular.module("tvApp").controller("favsCtrl",function($scope,FavoritesService){FavoritesService.getFavorites().then(function(res){$scope.favs=res})}),angular.module("tvApp").controller("uploadCtrl",function($scope,$routeParams,UploadService){$scope.showOptions=!0,$scope.isCheckboxSelected=function(type){return type===$scope.selectedType},$scope.show=function(){$scope.showOptions=!1},$scope.canShow=function(){return $scope.showOptions},$scope.upload=function(selectedType){if("video"===selectedType){var id=$scope.url.split("v=")[1].substring(0,11);UploadService.setVideo(id).then(function(data){console.log(data)})}else UploadService.setNew($scope.titulo,$scope.conteudo,$scope.url,new Date).then(function(data){console.log(data),$scope.data=data})}}),angular.module("tvApp").directive("youtube",function(){return function(scope,element){scope.$watch("data",function(){var el='<iframe width="853" height="480" id="vidz" src="//www.youtube.com/embed/'+scope.data.videoId+'?enablejsapi=1&version=3&rel=0" frameborder="0"></iframe>';element.html("").append(el)})}});